<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>document</title>
    <style>
        body { font-family: Helvetica; padding: 20px; background-color: #111111; color: #fff; }
        header { margin-bottom: 20px; }
        h1 { color: #8ACE00; }
        input, button { padding: 10px; margin-right: 10px; border-radius: 10px; border: none; }
        button { background-color: #8ACE00; color: white; cursor: pointer; }
        button:hover { background-color: #8ACE00; }
        .album-card {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #282828;
            border-radius: 8px;
            background-color: #181818;
        }
        .album-card img { border-radius: 5px; }
        a { color: #1DB954; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <header>
        <h1>Music recommendation</h1>
    </header>

    <div class="controls">
        <h3>How do you feel today?</h3>
        <input type="text" id="mood-input" >
        <button id="recommend-button">Recommend me</button>
    </div>

    <main id="main-content">
    </main>

    <script>
        const clientID = 'b8c4f39a900449289c3145fb2b56371d'; 
        const clientSecret = '9420043e1fd140d68488bc783cb5d5cc';

        const AUTH_URL = 'https://accounts.spotify.com/api/token';
        const SEARCH_URL = 'https://api.spotify.com/v1/search';

        const moodInput = document.getElementById('mood-input');
        const recommendButton = document.getElementById('recommend-button');
        const mainContent = document.getElementById('main-content');

        // å¿ƒæƒ…åˆ°é£æ ¼çš„æ˜ å°„è¡¨ (ä½ å¯ä»¥æ ¹æ®å–œå¥½ä¿®æ”¹)
        const MOOD_TO_GENRE = {
            'excited': 'Dance',
            'relaxed': 'Chill',
            'Sad': 'Blues',
            'focused': 'Indie',
            'calm': 'Indie',
            'angry': 'Rock',
            'Romantic': 'R&B',
            'Energetic': 'Pop',
            'Happy': 'Pop',
            ' Default': 'Pop' // é»˜è®¤é£æ ¼
        };

        // ç”¨äºä¿å­˜è·å–åˆ°çš„ Access Token
        let spotifyAccessToken = ''; 
        
// -----------------------------------------------------------------------------------
// ## æ­¥éª¤ 1: è·å– Access Token
// -----------------------------------------------------------------------------------

        /**
         * å‘ Spotify å‘é€ POST è¯·æ±‚è·å– Access Token
         */
        async function getSpotifyToken() {
            // æ„å»º POST è¯·æ±‚çš„ Body æ•°æ®
            const bodyData = new URLSearchParams();
            bodyData.append('grant_type', 'client_credentials');
            bodyData.append('client_id', clientID);
            bodyData.append('client_secret', clientSecret);

            try {
                const response = await fetch(AUTH_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded' 
                    },
                    body: bodyData
                });

                if (!response.ok) {
                    throw new Error(`è·å– Token å¤±è´¥: ${response.status}`);
                }

                const data = await response.json();
                spotifyAccessToken = data.access_token; // å­˜å‚¨ Token
                console.log("Access Token å·²æ›´æ–°ï¼Œæœ‰æ•ˆæ—¶é•¿:", data.expires_in, "ç§’");
                return spotifyAccessToken; 
                
            } catch (error) {
                console.error("Token è¯·æ±‚å‡ºé”™:", error.message);
                mainContent.innerHTML = `<p style="color: red;">ğŸš¨ é”™è¯¯ï¼šæ— æ³•è·å– Spotify Tokenã€‚è¯·æ£€æŸ¥ Client ID å’Œ Secret æ˜¯å¦æ­£ç¡®ã€‚</p>`;
                return null;
            }
        }
        
// -----------------------------------------------------------------------------------
// ## æ­¥éª¤ 2 & 3: æœç´¢å¹¶æ¨èä¸“è¾‘
// -----------------------------------------------------------------------------------

        /**
         * æ ¹æ®ç”¨æˆ·è¾“å…¥çš„å¿ƒæƒ…ï¼Œæœç´¢å¹¶æ¨èä¸€å¼  Spotify ä¸“è¾‘
         */
        async function recommendAlbum() {
            // å¦‚æœè¿˜æ²¡æœ‰ Tokenï¼Œå…ˆè·å–
            if (!spotifyAccessToken) {
                const token = await getSpotifyToken();
                if (!token) return; 
            }

            const userMood = moodInput.value.trim();
            const genre = MOOD_TO_GENRE[userMood] || MOOD_TO_GENRE[' Default']; 
            
            mainContent.innerHTML = `<p>æ­£åœ¨æœç´¢ ${userMood ? 'ä¸ã€' + userMood + 'ã€‘å¿ƒæƒ…åŒ¹é…çš„' : ''} ã€${genre}ã€‘é£æ ¼ä¸“è¾‘...</p>`;

            // æ„å»ºå¸¦æŸ¥è¯¢å‚æ•°çš„ URL
            const query = encodeURIComponent(`genre:"${genre}"`); 
            const fullUrl = `${SEARCH_URL}?q=${query}&type=album&limit=50`; // é™åˆ¶ 50 æ¡ç»“æœç”¨äºéšæœº

            try {
                const response = await fetch(fullUrl, {
                    method: 'GET',
                    headers: {
                        // åœ¨ Header ä¸­æºå¸¦ Token è¿›è¡Œæˆæƒ
                        'Authorization': `Bearer ${spotifyAccessToken}` 
                    }
                });

                if (!response.ok) {
                    // å¦‚æœ Token è¿‡æœŸæˆ–æ— æ•ˆï¼Œå¯èƒ½ä¼šåœ¨è¿™é‡ŒæŠ¥é”™ (401 Unauthorized)
                    if (response.status === 401) {
                         // å¼ºåˆ¶é‡æ–°è·å– Token å¹¶é‡è¯•
                         spotifyAccessToken = '';
                         await getSpotifyToken(); 
                         // ç®€åŒ–å¤„ç†ï¼Œç›´æ¥è®©ç”¨æˆ·é‡æ–°ç‚¹å‡»æŒ‰é’®
                         mainContent.innerHTML = '<p>Token å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç‚¹å‡»æŒ‰é’®æ¨èã€‚</p>';
                         return;
                    }
                    throw new Error(`Spotify API Error: ${response.status}`);
                }

                const data = await response.json();
                const albums = data.albums.items;

                if (albums.length === 0) {
                    mainContent.innerHTML = `<p>æŠ±æ­‰ï¼Œæ²¡æœ‰æ‰¾åˆ°ä¸ã€${genre}ã€‘é£æ ¼åŒ¹é…çš„ä¸“è¾‘ã€‚</p>`;
                    return;
                }

                // éšæœºé€‰æ‹©ä¸€å¼ ä¸“è¾‘
                const randomIndex = Math.floor(Math.random() * albums.length);
                const randomAlbum = albums[randomIndex];

                // æå–å¹¶å±•ç¤ºä¿¡æ¯
                displayAlbum(randomAlbum, genre);

            } catch (error) {
                mainContent.innerHTML = `<p style="color: red;">æ¨èå¤±è´¥: ${error.message}</p>`;
            }
        }

        /**
         * å°†ä¸“è¾‘ä¿¡æ¯æ¸²æŸ“åˆ°é¡µé¢
         */
        function displayAlbum(albumData, genre) {
            const albumName = albumData.name;
            const artistName = albumData.artists.map(a => a.name).join(', ');
            // ç¡®ä¿æœ‰å›¾ç‰‡ï¼Œå¦åˆ™ä½¿ç”¨ä¸€ä¸ªå ä½ç¬¦
            const albumImage = albumData.images[0] ? albumData.images[0].url : ''; 
            const spotifyUrl = albumData.external_urls.spotify; 
            
            mainContent.innerHTML = `
                <h2>ğŸ‰ ä½ çš„ã€${genre}ã€‘æ¨èä¸“è¾‘ï¼š</h2>
                <div class="album-card">
                    <img src="${albumImage}" alt="${albumName}" style="width: 150px; height: 150px;">
                    <div>
                        <h3>${albumName}</h3>
                        <p><strong>è‰ºæœ¯å®¶:</strong> ${artistName}</p>
                        <p><strong>å‘å¸ƒå¹´ä»½:</strong> ${albumData.release_date.substring(0, 4)}</p>
                        <a href="${spotifyUrl}" target="_blank">åœ¨ Spotify ä¸Šæ”¶å¬</a>
                    </div>
                </div>
            `;
        }

// -----------------------------------------------------------------------------------
// ## åˆå§‹åŒ–å’Œäº‹ä»¶ç»‘å®š
// -----------------------------------------------------------------------------------

        // é¡µé¢åŠ è½½æ—¶ç«‹å³å°è¯•è·å–ä¸€æ¬¡ Token (å‡å°‘ç”¨æˆ·ç­‰å¾…æ—¶é—´)
        getSpotifyToken();

        // ç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        recommendButton.addEventListener('click', recommendAlbum);
    </script>
</body>
</html>