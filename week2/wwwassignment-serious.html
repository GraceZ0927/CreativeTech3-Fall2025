<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>document</title>
    <style>
        body { font-family: Helvetica; padding: 20px; background-color: #111111; color: #fff; }
        header { margin-bottom: 20px; }
        h1 { color: #8ACE00; }
        input, button { padding: 10px; margin-right: 10px; border-radius: 10px; border: none; }
        button { background-color: #8ACE00; color: white; cursor: pointer; }
        button:hover { background-color: #8ACE00; }
        .album-card {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #282828;
            border-radius: 8px;
            background-color: #181818;
        }
        .album-card img { border-radius: 5px; }
        a { color: #1DB954; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <header>
        <h1>Music recommendation</h1>
    </header>

    <div class="controls">
        <h3>How do you feel today?</h3>
        <input type="text" id="mood-input" >
        <button id="recommend-button">Recommend me</button>
    </div>

    <main id="main-content">
    </main>

    <script>
        const clientID = 'b8c4f39a900449289c3145fb2b56371d'; 
        const clientSecret = '9420043e1fd140d68488bc783cb5d5cc';

        const AUTH_URL = 'https://accounts.spotify.com/api/token';
        const SEARCH_URL = 'https://api.spotify.com/v1/search';

        const moodInput = document.getElementById('mood-input');
        const recommendButton = document.getElementById('recommend-button');
        const mainContent = document.getElementById('main-content');

        // 心情到风格的映射表 (你可以根据喜好修改)
        const MOOD_TO_GENRE = {
            'excited': 'Dance',
            'relaxed': 'Chill',
            'Sad': 'Blues',
            'focused': 'Indie',
            'calm': 'Indie',
            'angry': 'Rock',
            'Romantic': 'R&B',
            'Energetic': 'Pop',
            'Happy': 'Pop',
            ' Default': 'Pop' // 默认风格
        };

        // 用于保存获取到的 Access Token
        let spotifyAccessToken = ''; 
        
// -----------------------------------------------------------------------------------
// ## 步骤 1: 获取 Access Token
// -----------------------------------------------------------------------------------

        /**
         * 向 Spotify 发送 POST 请求获取 Access Token
         */
        async function getSpotifyToken() {
            // 构建 POST 请求的 Body 数据
            const bodyData = new URLSearchParams();
            bodyData.append('grant_type', 'client_credentials');
            bodyData.append('client_id', clientID);
            bodyData.append('client_secret', clientSecret);

            try {
                const response = await fetch(AUTH_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded' 
                    },
                    body: bodyData
                });

                if (!response.ok) {
                    throw new Error(`获取 Token 失败: ${response.status}`);
                }

                const data = await response.json();
                spotifyAccessToken = data.access_token; // 存储 Token
                console.log("Access Token 已更新，有效时长:", data.expires_in, "秒");
                return spotifyAccessToken; 
                
            } catch (error) {
                console.error("Token 请求出错:", error.message);
                mainContent.innerHTML = `<p style="color: red;">🚨 错误：无法获取 Spotify Token。请检查 Client ID 和 Secret 是否正确。</p>`;
                return null;
            }
        }
        
// -----------------------------------------------------------------------------------
// ## 步骤 2 & 3: 搜索并推荐专辑
// -----------------------------------------------------------------------------------

        /**
         * 根据用户输入的心情，搜索并推荐一张 Spotify 专辑
         */
        async function recommendAlbum() {
            // 如果还没有 Token，先获取
            if (!spotifyAccessToken) {
                const token = await getSpotifyToken();
                if (!token) return; 
            }

            const userMood = moodInput.value.trim();
            const genre = MOOD_TO_GENRE[userMood] || MOOD_TO_GENRE[' Default']; 
            
            mainContent.innerHTML = `<p>正在搜索 ${userMood ? '与【' + userMood + '】心情匹配的' : ''} 【${genre}】风格专辑...</p>`;

            // 构建带查询参数的 URL
            const query = encodeURIComponent(`genre:"${genre}"`); 
            const fullUrl = `${SEARCH_URL}?q=${query}&type=album&limit=50`; // 限制 50 条结果用于随机

            try {
                const response = await fetch(fullUrl, {
                    method: 'GET',
                    headers: {
                        // 在 Header 中携带 Token 进行授权
                        'Authorization': `Bearer ${spotifyAccessToken}` 
                    }
                });

                if (!response.ok) {
                    // 如果 Token 过期或无效，可能会在这里报错 (401 Unauthorized)
                    if (response.status === 401) {
                         // 强制重新获取 Token 并重试
                         spotifyAccessToken = '';
                         await getSpotifyToken(); 
                         // 简化处理，直接让用户重新点击按钮
                         mainContent.innerHTML = '<p>Token 已过期，请重新点击按钮推荐。</p>';
                         return;
                    }
                    throw new Error(`Spotify API Error: ${response.status}`);
                }

                const data = await response.json();
                const albums = data.albums.items;

                if (albums.length === 0) {
                    mainContent.innerHTML = `<p>抱歉，没有找到与【${genre}】风格匹配的专辑。</p>`;
                    return;
                }

                // 随机选择一张专辑
                const randomIndex = Math.floor(Math.random() * albums.length);
                const randomAlbum = albums[randomIndex];

                // 提取并展示信息
                displayAlbum(randomAlbum, genre);

            } catch (error) {
                mainContent.innerHTML = `<p style="color: red;">推荐失败: ${error.message}</p>`;
            }
        }

        /**
         * 将专辑信息渲染到页面
         */
        function displayAlbum(albumData, genre) {
            const albumName = albumData.name;
            const artistName = albumData.artists.map(a => a.name).join(', ');
            // 确保有图片，否则使用一个占位符
            const albumImage = albumData.images[0] ? albumData.images[0].url : ''; 
            const spotifyUrl = albumData.external_urls.spotify; 
            
            mainContent.innerHTML = `
                <h2>🎉 你的【${genre}】推荐专辑：</h2>
                <div class="album-card">
                    <img src="${albumImage}" alt="${albumName}" style="width: 150px; height: 150px;">
                    <div>
                        <h3>${albumName}</h3>
                        <p><strong>艺术家:</strong> ${artistName}</p>
                        <p><strong>发布年份:</strong> ${albumData.release_date.substring(0, 4)}</p>
                        <a href="${spotifyUrl}" target="_blank">在 Spotify 上收听</a>
                    </div>
                </div>
            `;
        }

// -----------------------------------------------------------------------------------
// ## 初始化和事件绑定
// -----------------------------------------------------------------------------------

        // 页面加载时立即尝试获取一次 Token (减少用户等待时间)
        getSpotifyToken();

        // 绑定按钮点击事件
        recommendButton.addEventListener('click', recommendAlbum);
    </script>
</body>
</html>